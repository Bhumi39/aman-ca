# Azure Deployment Plan for ca-website Project

## **Goal**
Deploy the CA Website (Chartered Accountant firm website) to Azure using AZD for automated infrastructure provisioning and application deployment.

## **Project Information**
**CA Website Application**
- **Stack**: Node.js with Express.js framework
- **Type**: Full-stack web application (CA firm website with contact form, dynamic pages)
- **Language**: JavaScript
- **Entry Point**: app.js
- **Port**: 3000
- **Dependencies**: 
  - Express.js for web framework
  - MongoDB/Cosmos DB for data storage
  - Nodemailer for email notifications
  - Pusher for real-time updates
  - Body-parser for request handling
  - Express Handlebars for templating
- **Hosting**: Azure App Service

## **Azure Resources Architecture**

```mermaid
graph TD
    svcazureappservice_cawebsite["`ca-website
    Path: /
    Language: Node.js`"]
    
    subgraph "Compute Resources"
        azureappservice_cawebsite("`ca-website
        Azure App Service`")
    end
    
    subgraph "Data & Storage"
        azurecosmosdb_mongodb["`mongodb
        Azure Cosmos DB`"]
        azurekv["`Secrets & Credentials
        Azure Key Vault`"]
    end
    
    subgraph "Monitoring & Management"
        appinsights["`Application Insights
        Monitoring`"]
        loganalytics["`Log Analytics
        Workspace`"]
    end
    
    svcazureappservice_cawebsite --> |"hosted on"| azureappservice_cawebsite
    azureappservice_cawebsite --> |"secret"| azurecosmosdb_mongodb
    azureappservice_cawebsite --> |"managed identity"| azurekv
    azureappservice_cawebsite --> |"logs"| appinsights
    appinsights --> |"data"| loganalytics
```

## **Service Dependencies & Connections**
- **ca-website App Service**: Connects to Azure Cosmos DB (MongoDB) for storing contact form submissions, team data, and other content using connection strings stored in Key Vault.
- **Application Insights**: Monitors application health, performance metrics, and logs from the App Service.
- **Key Vault**: Securely stores database connection strings and email credentials.

## **Recommended Azure Resources**

### **Application: ca-website**
- **Hosting Service Type**: Azure App Service
- **Recommended SKU**: B1 (Basic - 1 vCPU, 1.75 GB RAM)
  - Suitable for small-to-medium traffic websites
  - Always On capability
  - 1 GB storage included
- **Configuration**:
  - **Language**: Node.js 18+ (LTS)
  - **Runtime Stack**: Node 18 LTS
  - **Environment Variables Required**:
    - `MONGODB_URI` - Connection string to Cosmos DB
    - `SMTP_USER` - Email credentials (from Key Vault)
    - `SMTP_PASS` - Email password (from Key Vault)
    - `PUSHER_APP_ID` - Pusher credentials
    - `PUSHER_KEY` - Pusher key
    - `PUSHER_SECRET` - Pusher secret
    - `PUSHER_CLUSTER` - Pusher cluster configuration
    - `NODE_ENV` - Set to "production"
    - `PORT` - Set to 80 (App Service default)

### **Dependency: MongoDB Database**
- **Service Type**: Azure Cosmos DB (MongoDB API)
- **Recommended SKU**: Standard S1 (400-40,000 RU/s provisioned)
  - Autoscale between 400-4000 RU/s recommended for starting
  - Multi-region redundancy option
- **Configuration**:
  - **API**: MongoDB
  - **Connection Type**: Secret (connection string via Key Vault)
  - **Environment Variables**: 
    - `MONGODB_URI` - Full connection string

### **Supporting Services**

#### **Azure Key Vault**
- **Purpose**: Securely store sensitive credentials and secrets
- **Recommended SKU**: Standard
- **Contents**:
  - Database connection string
  - Email SMTP credentials
  - Pusher credentials
- **Access**: Managed Identity-based access (no keys in app code)

#### **Application Insights**
- **Purpose**: Monitor application performance, errors, and user behavior
- **Configuration**: Connected to Log Analytics Workspace

#### **Log Analytics Workspace**
- **Purpose**: Centralized logging and analytics for Application Insights
- **Configuration**: Free tier (1 GB/day ingestion limit) suitable for this project

#### **User-Assigned Managed Identity**
- **Purpose**: Enable secure authentication between App Service and Key Vault/Cosmos DB without storing credentials
- **Permissions**:
  - Key Vault: Get, List secrets
  - Cosmos DB: Database Account Contributor

## **Security Configurations**
- ✅ **Managed Identity**: User-Assigned Managed Identity for secure resource authentication
- ✅ **Key Vault Integration**: All sensitive data (connection strings, credentials) stored in Key Vault
- ✅ **Network Security**: App Service configured with managed identity to access Cosmos DB and Key Vault
- ✅ **HTTPS**: App Service enforces HTTPS by default
- ✅ **Secrets Management**: No hardcoded credentials in application code

## **Execution Steps**

### **1. Create Azure Infrastructure Files for AZD**

#### **Step 1a: Check for Existing Files**
- [ ] Verify if `azure.yaml`, `infra/main.bicep`, and `infra/main.parameters.json` exist
- [ ] Location to check: `.azure/` directory

#### **Step 1b: Get Available Regions & SKUs**
- [ ] Obtain Azure Subscription ID
- [ ] Call `appmod-get-available-region-sku` tool to validate available regions for:
  - Microsoft.Web/sites (App Service)
  - Microsoft.DocumentDB/databaseAccounts (Cosmos DB)
  - Microsoft.KeyVault/vaults (Key Vault)
  - Microsoft.Insights/components (Application Insights)

#### **Step 1c: Generate Infrastructure Files**
- [ ] Call `appmod-get-iac-rules` to get Bicep best practices
- [ ] Generate `azure.yaml` with service configuration
- [ ] Generate `infra/main.bicep` with all Azure resources:
  - App Service Plan (B1 SKU)
  - App Service
  - Cosmos DB (MongoDB API) with autoscale
  - Key Vault
  - Application Insights
  - Log Analytics Workspace
  - User-Assigned Managed Identity
  - Role assignments
- [ ] Generate `infra/main.parameters.json` with parameters
- [ ] Validate generated files with `get_errors` tool

#### **Step 1d: Fix Any Bicep Errors**
- [ ] Review error output
- [ ] Iterate and fix until no errors remain

### **2. Environment Setup for AZD**

#### **Step 2a: Install Prerequisites**
- [ ] Install Azure CLI (az) - latest version
- [ ] Install AZD CLI - latest version
- [ ] Verify installation: `az --version` and `azd version`

#### **Step 2b: Initialize AZD Environment**
- [ ] Run `azd auth login` to authenticate with Azure
- [ ] Run `azd env new ca-website-env --no-prompt` to create a new environment
- [ ] Verify environment created in `.azure/.env.ca-website-env`

#### **Step 2c: Configure Environment Variables**
- [ ] Set subscription ID: `azd env set AZURE_SUBSCRIPTION_ID <your-subscription-id>`
- [ ] Set resource group: `azd env set AZURE_RESOURCE_GROUP ca-website-rg`
- [ ] Set region (e.g., eastus): `azd env set AZURE_LOCATION eastus`
- [ ] Set Node.js environment: `azd env set NODE_ENV production`

#### **Step 2d: Create Resource Group (if using resource group scope)**
- [ ] Run: `az group create --name ca-website-rg --location eastus`

### **3. Deployment**

#### **Step 3a: Dry Run Infrastructure**
- [ ] Run `azd provision --preview --no-prompt`
- [ ] Review the preview output to ensure all resources are correctly configured
- [ ] Verify resource names, SKUs, and locations match expectations

#### **Step 3b: Provision Infrastructure**
- [ ] Run `azd provision --no-prompt`
- [ ] Wait for provisioning to complete (typically 5-10 minutes)
- [ ] Monitor output for errors
- [ ] If fails, check error logs and retry with fixes

#### **Step 3c: Deploy Application**
- [ ] Run `azd deploy --no-prompt`
- [ ] Verify application deployment succeeds
- [ ] Check for build and startup errors

#### **Step 3d: Verify Deployment**
- [ ] Check application logs: `appmod-get-azd-app-logs`
- [ ] Verify no startup errors in logs
- [ ] Test application accessibility: `https://<app-name>.azurewebsites.net`
- [ ] Verify homepage loads
- [ ] Test contact form functionality

### **4. Post-Deployment Configuration**

#### **Step 4a: Configure Secrets in Key Vault**
- [ ] Set `MONGODB_URI` secret in Key Vault with Cosmos DB connection string
- [ ] Set `SMTP_USER` and `SMTP_PASS` for email credentials
- [ ] Set Pusher credentials (`PUSHER_APP_ID`, `PUSHER_KEY`, `PUSHER_SECRET`, `PUSHER_CLUSTER`)

#### **Step 4b: Update App Service Environment Variables**
- [ ] Link Key Vault secrets to App Service environment variables
- [ ] Verify secrets are properly injected

#### **Step 4c: Enable Monitoring**
- [ ] Verify Application Insights is collecting data
- [ ] Set up alerts for error rates and response times
- [ ] Configure log retention in Log Analytics

### **5. Summarize Results**
- [ ] Use `appmod-summarize-result` tool to generate deployment summary
- [ ] Output: `.azure/summary.copilotmd`
- [ ] Document provisioned resources, file paths, and deployment status

## **Progress Tracking**

Progress will be updated after each step:
- [ ] Step 1: Infrastructure files creation
- [ ] Step 2: Environment setup
- [ ] Step 3: Infrastructure provisioning
- [ ] Step 4: Application deployment
- [ ] Step 5: Deployment summary

**Created**: 2026-02-21
**Status**: Ready for execution
**Next Action**: Provide Azure subscription ID and preferred region
